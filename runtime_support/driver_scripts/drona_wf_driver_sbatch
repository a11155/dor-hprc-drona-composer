#!/bin/bash
# Usage: drona_wf_driver_sbatch <job_file1> [job_file2] ... [job_fileN]

# 1. Check for at least one job file
if [ "$#" -lt 1 ]; then
    echo "Usage: drona_wf_driver_sbatch <job_file1> [job_file2...]"
    exit 1
fi

JOB_FILES=("$@")
PREV_JOBID=""
ALL_JOBIDS=()

# 2. Iterate over the job files to build the pipeline
for JOB_FILE in "${JOB_FILES[@]}"; do
    if [ -z "$PREV_JOBID" ]; then
        # First job: submit normally
        SUBMIT_OUTPUT=$(/sw/local/bin/sbatch "$JOB_FILE")
    else
        # Subsequent jobs: submit with dependency on the previous job
        SUBMIT_OUTPUT=$(/sw/local/bin/sbatch --dependency=afterok:"$PREV_JOBID" "$JOB_FILE")
    fi

    # Extract Job ID
    CURRENT_ID=$(echo "$SUBMIT_OUTPUT" | sed -n 's/.*Submitted batch job \([0-9]\+\).*/\1/p')

    if [ -z "$CURRENT_ID" ]; then
        echo "Error: Failed to submit $JOB_FILE"
        exit 1
    fi

    ALL_JOBIDS+=("$CURRENT_ID")
    PREV_JOBID="$CURRENT_ID"
done

# 3. Construct the JSON string for "jobinfo"
JOB_JSON_ARRAY=""
for id in "${ALL_JOBIDS[@]}"; do
    [ -n "$JOB_JSON_ARRAY" ] && JOB_JSON_ARRAY+=", "
    JOB_JSON_ARRAY+="{\"id\": $id}"
done

# 4. Update the Database Record
# Using the specific path: ${DRONA_RUNTIME_DIR}/db_access/drona_db_retriever.py
python3 "${DRONA_RUNTIME_DIR}/db_access/drona_db_retriever.py" --edit  -i "$DRONA_WF_ID" --runtime-meta "{\"jobinfo\": [$JOB_JSON_ARRAY]}" > /dev/null

# 5. Formatted Output
if [ "${#ALL_JOBIDS[@]}" -eq 1 ]; then
    # Single Job Output
    echo "Job submitted successfully: ID ${ALL_JOBIDS[0]}"
else
    # Pipeline Output
    echo "Pipeline submitted successfully:"
    for i in "${!ALL_JOBIDS[@]}"; do
        if [ "$i" -eq 0 ]; then
            echo "  [Start] ➔ Job ID: ${ALL_JOBIDS[$i]}"
        else
            echo "      └─➔ Job ID: ${ALL_JOBIDS[$i]} (depends on ${ALL_JOBIDS[$((i-1))]})"
        fi
    done
fi
echo "" # New line at the end
